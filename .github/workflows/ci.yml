name: CI

on:
  push:
    branches: [master, main, rebrand, feature/*]
  pull_request:
    branches: [master, main]

jobs:
  # macOS Build and Test
  build-macos:
    name: macOS (Swift ${{ matrix.swift }})
    runs-on: macos-latest
    strategy:
      matrix:
        swift: ["6.2"]
    steps:
      - uses: actions/checkout@v4

      - name: Show Swift version
        run: swift --version

      - name: Build
        run: swift build -v

      - name: Run tests
        id: test
        run: |
          swift test --parallel --xunit-output test-results.xml 2>&1 | tee test-output.txt
          echo "test_output<<EOF" >> $GITHUB_OUTPUT
          cat test-output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate test summary
        if: always()
        run: |
          echo "## ðŸŽ macOS Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse test results
          if [ -f test-results.xml ]; then
            TESTS=$(grep -o 'tests="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
            FAILURES=$(grep -o 'failures="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
            ERRORS=$(grep -o 'errors="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
            TIME=$(grep -o 'time="[0-9.]*"' test-results.xml | head -1 | grep -o '[0-9.]*' || echo "0")

            PASSED=$((TESTS - FAILURES - ERRORS))

            if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
              echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | $TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILURES âŒ |" >> $GITHUB_STEP_SUMMARY
            echo "| Errors | $ERRORS âš ï¸ |" >> $GITHUB_STEP_SUMMARY
            echo "| Duration | ${TIME}s |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No test results file found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>ðŸ“‹ Test Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 test-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-macos
          path: |
            test-results.xml
            test-output.txt

  # iOS Build and Test (Simulator)
  build-ios:
    name: iOS (Xcode ${{ matrix.xcode }})
    runs-on: macos-latest
    strategy:
      matrix:
        xcode: ["16.0"]
        destination: ["platform=iOS Simulator,name=iPhone 16,OS=18.0"]
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode ${{ matrix.xcode }}
        run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode }}.app

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build for iOS
        run: |
          xcodebuild build \
            -scheme SwiftHeadlessWebKit-Package \
            -destination "${{ matrix.destination }}" \
            -skipPackagePluginValidation \
            | xcpretty || true

      - name: Test on iOS Simulator
        id: test
        run: |
          xcodebuild test \
            -scheme SwiftHeadlessWebKit-Package \
            -destination "${{ matrix.destination }}" \
            -skipPackagePluginValidation \
            -resultBundlePath TestResults.xcresult \
            2>&1 | tee test-output.txt | xcpretty || true

      - name: Generate test summary
        if: always()
        run: |
          echo "## ðŸ“± iOS Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if tests passed based on output
          if grep -q "Test Succeeded" test-output.txt 2>/dev/null || grep -q "BUILD SUCCEEDED" test-output.txt 2>/dev/null; then
            echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
          elif grep -q "FAILED" test-output.txt 2>/dev/null; then
            echo "âŒ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Test status unknown**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>ðŸ“‹ Test Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 test-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-ios
          path: |
            TestResults.xcresult
            test-output.txt

  # Linux Build and Test
  build-linux:
    name: Linux (Swift latest)
    runs-on: ubuntu-latest
    container:
      image: swift:latest
    steps:
      - uses: actions/checkout@v4

      - name: Show Swift version
        run: swift --version

      - name: Build
        run: swift build -v

      - name: Run tests
        id: test
        run: |
          swift test --parallel --xunit-output test-results.xml 2>&1 | tee test-output.txt
          echo "test_output<<EOF" >> $GITHUB_OUTPUT
          cat test-output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate test summary
        if: always()
        run: |
          echo "## ðŸ§ Linux Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse test results
          if [ -f test-results.xml ]; then
            TESTS=$(grep -o 'tests="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
            FAILURES=$(grep -o 'failures="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
            ERRORS=$(grep -o 'errors="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
            TIME=$(grep -o 'time="[0-9.]*"' test-results.xml | head -1 | grep -o '[0-9.]*' || echo "0")

            PASSED=$((TESTS - FAILURES - ERRORS))

            if [ "$FAILURES" = "0" ] && [ "$ERRORS" = "0" ]; then
              echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | $TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILURES âŒ |" >> $GITHUB_STEP_SUMMARY
            echo "| Errors | $ERRORS âš ï¸ |" >> $GITHUB_STEP_SUMMARY
            echo "| Duration | ${TIME}s |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No test results file found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>ðŸ“‹ Test Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 test-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-linux
          path: |
            test-results.xml
            test-output.txt

  # Summary and PR Comment
  ci-success:
    name: CI Success
    needs: [build-macos, build-ios, build-linux]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      pull-requests: write
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
        continue-on-error: true

      - name: Check all jobs passed
        id: check
        run: |
          MACOS_RESULT="${{ needs.build-macos.result }}"
          IOS_RESULT="${{ needs.build-ios.result }}"
          LINUX_RESULT="${{ needs.build-linux.result }}"

          echo "macos_result=$MACOS_RESULT" >> $GITHUB_OUTPUT
          echo "ios_result=$IOS_RESULT" >> $GITHUB_OUTPUT
          echo "linux_result=$LINUX_RESULT" >> $GITHUB_OUTPUT

          if [[ "$MACOS_RESULT" != "success" ]] || \
             [[ "$IOS_RESULT" != "success" ]] || \
             [[ "$LINUX_RESULT" != "success" ]]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "One or more jobs failed"
          else
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "All CI jobs passed!"
          fi

      - name: Generate final summary
        run: |
          echo "# ðŸ§ª CI Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status emoji helper
          status_emoji() {
            if [ "$1" = "success" ]; then echo "âœ…"; else echo "âŒ"; fi
          }

          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ macOS | $(status_emoji ${{ needs.build-macos.result }}) ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± iOS | $(status_emoji ${{ needs.build-ios.result }}) ${{ needs.build-ios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ Linux | $(status_emoji ${{ needs.build-linux.result }}) ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse individual test results if available
          for platform in macos linux; do
            if [ -f "test-results/test-results-$platform/test-results.xml" ]; then
              echo "### ${platform^} Test Details" >> $GITHUB_STEP_SUMMARY
              TESTS=$(grep -o 'tests="[0-9]*"' "test-results/test-results-$platform/test-results.xml" | head -1 | grep -o '[0-9]*' || echo "0")
              FAILURES=$(grep -o 'failures="[0-9]*"' "test-results/test-results-$platform/test-results.xml" | head -1 | grep -o '[0-9]*' || echo "0")
              echo "- Tests: $TESTS, Failures: $FAILURES" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          if [ "${{ steps.check.outputs.status }}" = "passed" ]; then
            echo "## âœ… All CI checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Some CI checks failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const macosResult = '${{ needs.build-macos.result }}';
            const iosResult = '${{ needs.build-ios.result }}';
            const linuxResult = '${{ needs.build-linux.result }}';
            const status = '${{ steps.check.outputs.status }}';

            const statusEmoji = (result) => result === 'success' ? 'âœ…' : 'âŒ';

            let body = `## ðŸ§ª CI Test Results\n\n`;
            body += `| Platform | Status |\n`;
            body += `|----------|--------|\n`;
            body += `| ðŸŽ macOS (Swift 6.2) | ${statusEmoji(macosResult)} ${macosResult} |\n`;
            body += `| ðŸ“± iOS (Xcode 16.0) | ${statusEmoji(iosResult)} ${iosResult} |\n`;
            body += `| ðŸ§ Linux (Swift latest) | ${statusEmoji(linuxResult)} ${linuxResult} |\n\n`;

            if (status === 'passed') {
              body += `### âœ… All CI checks passed!\n\n`;
              body += `The code has been tested on all platforms and is ready for review.\n`;
            } else {
              body += `### âŒ Some CI checks failed\n\n`;
              body += `Please check the [workflow run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}) for details.\n`;
            }

            body += `\n---\n`;
            body += `ðŸ“Š [View full test results](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ§ª CI Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if any job failed
        if: steps.check.outputs.status == 'failed'
        run: exit 1
